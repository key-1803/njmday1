<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>4-Cut Photobooth</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      gap: 20px;
      padding: 20px;
    }

    #left {
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
    }

    video {
      transform: scaleX(-1);
      width: 300px;
      border-radius: 8px;
    }

    #countdown {
      font-size: 3rem;
      font-weight: bold;
      color: red;
      position: absolute;
      top: 20px;
    }

    button {
      padding: 10px 20px;
      font-size: 1rem;
      margin-top: 5px;
    }

    #right {
      position: relative;
    }

    #finalCanvas {
      width: 300px;
      border: 1px solid #ccc;
    }

    #overlayFrame {
      position: absolute;
      top: 0;
      left: 0;
      width: 300px;
      pointer-events: none;
    }
  </style>
</head>
<body>

<div id="left">
  <video id="video" autoplay playsinline></video>
  <div id="countdown"></div>
  <button id="takePhoto">Take Photo</button>
  <button id="retake">Retake</button>
  <button id="download">Download</button>
</div>

<div id="right">
  <canvas id="finalCanvas" width="682" height="2048"></canvas>
  <img id="overlayFrame" src="frame.png" alt="Frame">
</div>

<script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('finalCanvas');
  const ctx = canvas.getContext('2d');
  const countdownEl = document.getElementById('countdown');

  const takeBtn = document.getElementById('takePhoto');
  const retakeBtn = document.getElementById('retake');
  const downloadBtn = document.getElementById('download');

  let photoIndex = 0;
  const maxPhotos = 4;

  // Sesuaikan dengan ukuran dan posisi lubang di IMG_4009.png
  const photoPositions = [
    { x: 111, y: 165, width: 457, height: 451 },
    { x: 111, y: 591, width: 457, height: 451 },
    { x: 111, y: 1017, width: 457, height: 451 },
    { x: 111, y: 1443, width: 457, height: 451 },
  ];

  // Setup kamera
  navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
    video.srcObject = stream;
  });

  function drawMirrored(ctx, video, x, y, w, h) {
    const tmpCanvas = document.createElement('canvas');
    tmpCanvas.width = w;
    tmpCanvas.height = h;
    const tmpCtx = tmpCanvas.getContext('2d');
    tmpCtx.translate(w, 0);
    tmpCtx.scale(-1, 1);
    tmpCtx.drawImage(video, 0, 0, w, h);
    ctx.drawImage(tmpCanvas, x, y, w, h);
  }

  function countdown(seconds) {
    return new Promise(resolve => {
      countdownEl.textContent = seconds;
      const interval = setInterval(() => {
        seconds--;
        countdownEl.textContent = seconds > 0 ? seconds : '';
        if (seconds <= 0) {
          clearInterval(interval);
          resolve();
        }
      }, 1000);
    });
  }

  takeBtn.onclick = async () => {
    if (photoIndex >= maxPhotos) return;

    await countdown(3);

    const pos = photoPositions[photoIndex];
    drawMirrored(ctx, video, pos.x, pos.y, pos.width, pos.height);
    photoIndex++;

    if (photoIndex >= maxPhotos) {
      takeBtn.disabled = true;
    }
  };

  retakeBtn.onclick = () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    photoIndex = 0;
    takeBtn.disabled = false;
  };

  downloadBtn.onclick = () => {
    const link = document.createElement('a');
    link.download = 'photostrip.png';
    link.href = canvas.toDataURL();
    link.click();
  };
</script>

</body>
</html>
